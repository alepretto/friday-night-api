steps:
  # Build Docker image
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "us-central1-docker.pkg.dev/$PROJECT_ID/friday-night/api:$SHORT_SHA"
      - "-t"
      - "us-central1-docker.pkg.dev/$PROJECT_ID/friday-night/api:latest"
      - "."

  # Push image to Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "--all-tags",
        "us-central1-docker.pkg.dev/$PROJECT_ID/friday-night/api",
      ]

  # Run database migrations
  - name: "us-central1-docker.pkg.dev/$PROJECT_ID/friday-night/api:$SHORT_SHA"
    entrypoint: ".venv/bin/alembic"
    args: ["upgrade", "head"]
    secretEnv:
      [
        "DATABASE_URL",
        "DIRECT_URL",
        "SUPABASE_URL",
        "SUPABASE_SERVICE_ROLE_KEY",
        "SUPABASE_JWT_SECRET",
      ]

  # Deploy to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "gcloud"
    args:
      - "run"
      - "deploy"
      - "friday-night-api"
      - "--image"
      - "us-central1-docker.pkg.dev/$PROJECT_ID/friday-night/api:$SHORT_SHA"
      - "--region"
      - "us-central1"
      - "--platform"
      - "managed"
      - "--allow-unauthenticated"
      - "--port"
      - "8000"
      - "--memory"
      - "512Mi"
      - "--cpu"
      - "1"
      - "--min-instances"
      - "0"
      - "--max-instances"
      - "2"
      - "--set-secrets"
      - "DATABASE_URL=DATABASE_URL:latest,DIRECT_URL=DIRECT_URL:latest,SUPABASE_URL=SUPABASE_URL:latest,SUPABASE_SERVICE_ROLE_KEY=SUPABASE_SERVICE_ROLE_KEY:latest,SUPABASE_JWT_SECRET=SUPABASE_JWT_SECRET:latest"
      - "--set-env-vars"
      - 'CORS_ORIGINS=["*"]'

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/DATABASE_URL/versions/latest
      env: DATABASE_URL
    - versionName: projects/$PROJECT_ID/secrets/DIRECT_URL/versions/latest
      env: DIRECT_URL
    - versionName: projects/$PROJECT_ID/secrets/SUPABASE_URL/versions/latest
      env: SUPABASE_URL
    - versionName: projects/$PROJECT_ID/secrets/SUPABASE_SERVICE_ROLE_KEY/versions/latest
      env: SUPABASE_SERVICE_ROLE_KEY
    - versionName: projects/$PROJECT_ID/secrets/SUPABASE_JWT_SECRET/versions/latest
      env: SUPABASE_JWT_SECRET

options:
  logging: CLOUD_LOGGING_ONLY

images:
  - "us-central1-docker.pkg.dev/$PROJECT_ID/friday-night/api"
